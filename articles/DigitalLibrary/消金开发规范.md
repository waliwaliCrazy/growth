<h1> 开发手册 </h1>

**Table of Contents**

- [目标](#%e7%9b%ae%e6%a0%87)
- [原则](#%e5%8e%9f%e5%88%99)
- [代码规范](#%e4%bb%a3%e7%a0%81%e8%a7%84%e8%8c%83)
  - [规约](#%e8%a7%84%e7%ba%a6)
  - [日志和异常](#%e6%97%a5%e5%bf%97%e5%92%8c%e5%bc%82%e5%b8%b8)
  - [单元测试](#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95)
  - [SQL](#sql)
  - [安全](#%e5%ae%89%e5%85%a8)
  - [建议](#%e5%bb%ba%e8%ae%ae)
  - [review](#review)
- [流程](#%e6%b5%81%e7%a8%8b)
  - [gitlab pull meger 时,写上主要改动的地方和逻辑，方便review](#gitlab-pull-meger-%e6%97%b6%e5%86%99%e4%b8%8a%e4%b8%bb%e8%a6%81%e6%94%b9%e5%8a%a8%e7%9a%84%e5%9c%b0%e6%96%b9%e5%92%8c%e9%80%bb%e8%be%91%e6%96%b9%e4%be%bfreview)
  - [Teambition 使用](#teambition-%e4%bd%bf%e7%94%a8)
  - [每周二周会（东旭周会后）](#%e6%af%8f%e5%91%a8%e4%ba%8c%e5%91%a8%e4%bc%9a%e4%b8%9c%e6%97%ad%e5%91%a8%e4%bc%9a%e5%90%8e)
    - [讨论需求（20分钟）](#%e8%ae%a8%e8%ae%ba%e9%9c%80%e6%b1%8220%e5%88%86%e9%92%9f)
    - [讨论上周（10分钟）](#%e8%ae%a8%e8%ae%ba%e4%b8%8a%e5%91%a810%e5%88%86%e9%92%9f)
    - [项目技术讨论（30分钟）](#%e9%a1%b9%e7%9b%ae%e6%8a%80%e6%9c%af%e8%ae%a8%e8%ae%ba30%e5%88%86%e9%92%9f)
  - [上线流程](#%e4%b8%8a%e7%ba%bf%e6%b5%81%e7%a8%8b)
    - [开始测试时](#%e5%bc%80%e5%a7%8b%e6%b5%8b%e8%af%95%e6%97%b6)
    - [准备上线](#%e5%87%86%e5%a4%87%e4%b8%8a%e7%ba%bf)
    - [上线后](#%e4%b8%8a%e7%ba%bf%e5%90%8e)
- [打造资料库](#%e6%89%93%e9%80%a0%e8%b5%84%e6%96%99%e5%ba%93)
  - [在gitlab建立一个消金的文档仓库 Athena](#%e5%9c%a8gitlab%e5%bb%ba%e7%ab%8b%e4%b8%80%e4%b8%aa%e6%b6%88%e9%87%91%e7%9a%84%e6%96%87%e6%a1%a3%e4%bb%93%e5%ba%93-athena)
- [注意事项](#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9)

# 目标

- 整洁
- 统一
- 易读
- 模块化
- 心情愉悦

# 原则

- 短小精悍 最多50行，建议30行以下
- KISS “kiss Simple and Stupid” 的缩写,意思是“保持简单和愚蠢”
- 六大原则
  - 单一职责原则(Single Responsibility Principle, SRP)
    - 一个类只负责一个功能领域中的相应职责
  - 开闭原则(Open-Closed Principle, OCP)
    - 对扩展开放，对修改关闭，在不修改原有内部代码的情况支持扩展
  - 里氏代换原则(Liskov Substitution Principle, LSP)
  - 依赖倒转原则(Dependency Inversion  Principle, DIP)
    - 依赖抽象而不是实现
  - 接口隔离原则(Interface  Segregation Principle, ISP
  - 迪米特法则(Law of  Demeter, LoD)（最少知识法则）

# 代码规范

## 规约

- 返回值不要使用Map
- 尽量减少魔法值，多使用枚举或常量
- 命名
  - 禁止使用Oracle、MySQL、JavaScript、Java、Python、Go 关键字命名
  - 使用英文，不能中英文混用，金融专业名词问卓阳
  - Java 代码使用驼峰英文，常量大写下划线
  - 枚举类加 Enum 后缀
  - 查询方法 get 开头，不再使用 find / select
  - 只能使用专业约定的缩写，不要制造缩写，不要嫌变量名长
    - 例如 channelRequestNo 和 channelRN
  - 不要在不同的类、表、项目中使用近义的英文，应该使用同一个
    - 例如 status、verify_status
  - DTO 数据传输对象
  - DO 数据库实体对象
- 风格
  - 缩进使用2个空格
  - 单行长度不建议超过 120, 为了语义通顺，可以减少没必要的换行
  - 方法参数尽量少于10个
  - 方法有效代码行数不建议超过 50 行
    - 过长的方法难以维护和理解
    - 例外：
      - 某些对象初始化导致方法过长
      - 方法处理严重依赖上下文结果，比如计算逻辑
  - 方法复杂度建议不超过 10
  - 不同逻辑、不同语义代码之间插入一个空行
  - 控制语句必须加括号，单行也不例外
  - 注释必须使用 javadoc 规范，注意不加冒号
    - @author 作者
    - @param 参数名 参数用途
    - @since 版本号/时间
    - @see 关联类
    - @return 返回值描述
- OOP
  - 重写 toString()
  - 过时方法加 Deprecated 注解
  - 调用 equals 时注意空指针
  - 调用其他方法也注意空指针
  - 注意访问级别
- 集合处理
  - 优先使用 ecm-utils 判空，虽然mybaits的返回值空集合，但也不要直接调用 size 判空
  - 如果能预知容量，初始化时规定容量，防止扩容
- 注释
  - 被注释掉的代码前一定要有原因
  - 复杂逻辑最好在方法上写出实现思路
  - 方法参数如果是枚举值，尽量写一下

## 日志和异常

- catch 就是为了处理异常，不能什么都不做，至少需要打日志
- 不要使用 e.printStackException 打印日志
- 使用 warn 记录参数错误问题，不要使用error
- 对于可重试且不是系统配置问题导致的错误，打印warn
- 系统配置错误、重试不能解决，打印error
- 打印log 是 exception 对象，不用出现在占位符中
- 日志描述内容使用英文下划线，尽量不要使用空格，kibana 搜索有问题
- 框架日志看情况调整级别
- 关键流程，如进件、审核、还款流程多打关键日志
- 关键流程分支有日志
- 日志必须有效，可用于排查问题

## 单元测试

- 提高单元测试覆盖率
- 原则
  - 独立
  - 可重复
  - 自动化
## SQL

- 注意 Null 值判断

## 安全

- 四要素脱敏
- 用户只能访问自己的数据
  - 用户账单
  - 机构查询自己的账单
- 不要依赖前端校验
- SQL 注入
## 建议

- 过于垃圾代码和配置（过时，无法访问）直接删除
- 多用组合，少用继承
- 参数最小化，避免大而空
- 多用工具类，少写重复代码 优先级 ecm-utils/guava/apache
- 时期计算使用java8新语法，或者 jode工具类
- 不要重复自己 DIY



# 流程

## gitlab pull meger 时,写上主要改动的地方和逻辑，方便review

## Teambition 使用
- 新增值班记录 留存已经解决和待解决的问题

## 每周二周会（东旭周会后）

### 讨论需求（20分钟）
- 拆解东旭的本周计划，指定备份人，code review 人
- 讨论新需求中是否对老流程有影响，是否兼容，是否有坑
- 做的人提出大致方案，备份人跟进
- 第一做这个需求的人提出建议
### 讨论上周（10分钟）
- 上线内容和改动逻辑
- 线上bug和解决方案
- 数据导出方案和脚本
### 项目技术讨论（30分钟）
- 项目规划和现有问题
- 旧代码删除讨论
- 新项目讨论
- 技术讨论
- 原来做过的项目讨论（不一定是本公司的，主要提供一些不一样的解决方案）
- 新技术分享（3分钟，每周一个）
  - 工具类
  - 小项目
  - 解决方案
  - 技术热点

## 上线流程

### 开始测试时
- 检查redmine是否存在遗漏（flyway，新资源，SQL）
- 如果需要运维配合，开始和老铁聊聊人生
- 项目测试中，是否新加入项目

### 准备上线
- 如果有 flyway 变更
  - 使用一个空本地库，那其上执行 flyway
  - 跑单测，如果有问题，解决后再上线
- 检查代码是否有冲突
- 检查redmine是否存在遗漏，防止出现项目漏上，flyway漏写情况
- 检查代码是否有配置改动，注意生产环境配置
- 检查是否有SQL脚本（初始化数据）
- 检查代码是否有快照版本
- 检查是否有定时任务配置修改（admin，job）
- 代码一定要本地编译通过
- 检查是否有新申请权限（消金后台权限，核心网关权限）
### 上线后
- 确认flyway是否执行
- 确认SQL是否执行
- 确认代码是否有误
- 确认项目是否上齐
- 确认定时任务修改
- 确认功能是否符合预期（产品）
- 确认权限是否开通（产品）
- 调用 info 接口，检测是否上线完成（建议做功能）
  
# 打造资料库

## 在gitlab建立一个消金的文档仓库 Athena

- 三方接口文档
- 消金业务文档
- 消金上线文档
- 上线记录
- 线上问题解决方案
- 数据报表导出相关方法(典型)
- 需求解决方案和影响
  - 提前编写技术方案
- wiki 写一写相关业务流程文档

# 注意事项

1. 不经过卫卫允许，不要删测试数据
2. 不要在开发环境直连测试环境，可能造成脏数据
3. 进入联调阶段，使用联调环境（待部署）
4. 工作时单线程比多线程快